# Mobile Network Signaling Parser - Desktop Version

## Overview

This parser-desktop folder contains tools for parsing and analyzing mobile network signaling data from QMDL (Qualcomm Diagnostics Log) files and PCAP (Packet Capture) files. It converts these files into XML and CSV formats for detailed analysis of cellular network protocols.

## Folder Structure

```
parser-desktop/
├── qmdl_reader.py          # Main QMDL/PCAP processing script
├── datawriter.py           # Enhanced data writing with PyShark integration
├── fileio.py               # File input/output handling
├── qualcomm/               # Qualcomm-specific parsers
├── dissector/              # Wireshark dissector files
├── pcap/                   # Sample PCAP files
├── output-v8.xml           # Sample XML output
├── output-v8.csv           # Sample CSV output
└── README.md              # This file
```

## Environment Setup

### 1. Create Python Virtual Environment

```bash
# Navigate to the parser-desktop directory
cd parser-desktop

# Create a virtual environment
python3 -m venv venv

# Activate the virtual environment
source venv/bin/activate

# On Windows, use:
# venv\Scripts\activate
```

### 2. Install Required Dependencies

```bash
# Install essential dependencies
pip install pyshark bitstring pyusb pyserial packaging

# Optional: Install additional dependencies for enhanced functionality
pip install lxml pandas openpyxl
```

### 3. Verify Installation

```bash
# Check Python version
python3 --version

# Check if PyShark is available
python3 -c "import pyshark; print('PyShark available')"
```

## Quick Start

### Basic Usage Commands

#### 1. QMDL to CSV/XML Conversion

```bash
# Process QMDL file with XML and CSV output
python3 qmdl_reader.py ./diag_log.qmdl -o output-v1.xml -c output-v1.csv

# Process with custom minimum file size
python3 qmdl_reader.py ./large_dump.qmdl -s 50 -o output-v1.xml -c output-v1.csv
```

#### 2. PCAP to CSV/XML Conversion

```bash
# Process PCAP file with XML and CSV output
python3 qmdl_reader.py ./pcap/attach_reject.pcap -o output-v1.xml -c output-v1.csv

# Process PCAP without CSV export
python3 qmdl_reader.py ./pcap/attach_reject.pcap -o output-v1.xml
```

## Process Flow Documentation

### QMDL File Processing Flow

#### Input: QMDL File

- **File Type**: Qualcomm Diagnostics Log file (.qmdl)
- **Source**: Generated by Qualcomm-based mobile devices during diagnostics capture
- **Typical Size**: 10MB - 2GB (larger files provide more comprehensive signaling data)
- **Content**: Binary-encoded signaling messages including RRC, NAS, and other protocol layers

#### Step 1: File Validation and Setup

- **Files Involved**:
  - `qmdl_reader.py` - Main processing script
  - `fileio.py` - File input/output handling
- **Process**:
  - Check minimum file size (default: 10MB)
  - Determine file type (QMDL vs PCAP)
  - Initialize DataWriter for output processing

#### Step 2: QMDL Parsing

- **Files Involved**:
  - `qualcomm/qualcommparser.py` - Main Qualcomm parser
  - `qualcomm/diag1xlogparser.py` - 1x log parsing
  - `qualcomm/diaggsmlogparser.py` - GSM log parsing
  - `qualcomm/diagltelogparser.py` - LTE log parsing
  - `qualcomm/diagnrlogparser.py` - NR (5G) log parsing
- **Process**:
  - Parse binary QMDL format into structured messages
  - Extract protocol layers (RRC, NAS, MAC, etc.)
  - Apply Qualcomm-specific decoding logic

#### Step 3: Data Writing and Conversion

- **Files Involved**:
  - `datawriter.py` - Enhanced data writer
  - `dissector/packet-*.c` - Protocol dissectors
- **Process**:
  - Convert parsed messages to intermediate PCAP format
  - Apply Wireshark dissectors for detailed protocol analysis
  - Generate PDML XML output with full protocol tree

#### Step 4: CSV Export

- **Files Involved**:
  - `datawriter.py` - CSV export functionality
- **Process**:
  - Extract RRC (Radio Resource Control) specific fields
  - Create structured CSV with all available RRC parameters
  - Include packet numbers, timestamps, and field values

#### Output Files Generated:

1. **XML Output** (`output-vX.xml`): PDML-formatted XML with complete protocol dissection
2. **CSV Output** (`output-vX.csv`): RRC-specific data in spreadsheet format
3. **Temporary Files**: Intermediate PCAP files created during processing (automatically managed)

### PCAP File Processing Flow

#### Input: PCAP File

- **File Type**: Packet Capture file (.pcap, .pcapng)
- **Source**: Network packet captures containing GSMTAP or other protocol data
- **Typical Size**: Varies based on capture duration and traffic volume
- **Content**: Already decoded network packets with GSMTAP headers

#### Step 1: File Validation

- **Files Involved**:
  - `qmdl_reader.py` - File type detection
- **Process**:
  - Identify PCAP file format
  - Verify file integrity and readability

#### Step 2: Direct PCAP Processing

- **Files Involved**:
  - `datawriter.py` - PCAP processing methods
- **Process**:
  - Use PyShark for direct PCAP analysis (if available)
  - Apply Wireshark dissectors to packet data
  - Extract protocol information from existing packet structure

#### Step 3: Data Extraction and Export

- **Files Involved**:
  - `datawriter.py` - PDML and CSV export functions
- **Process**:
  - Convert PCAP packets to PDML XML format
  - Extract RRC data for CSV export
  - Maintain packet numbering and timestamps

#### Output Files Generated:

1. **XML Output** (`output-vX.xml`): PDML XML representation of PCAP data
2. **CSV Output** (`output-vX.csv`): Extracted RRC data in CSV format

## Key Components Explained

### qmdl_reader.py

**Purpose**: Main command-line interface for processing QMDL and PCAP files

**Key Functions**:

- `read_qmdl_file_to_pdml()` - Main processing entry point
- `process_qmdl_with_data_writer()` - QMDL to DataWriter processing
- `process_pcap_file()` - PCAP file processing
- `read_qmdl_file()` - Legacy QMDL processing method

**Command Line Options**:

- `-o, --output`: Output PDML XML file path
- `-c, --csv`: Output CSV file path for RRC data
- `-s, --size`: Minimum file size in MB for QMDL files (default: 10)

### datawriter.py

**Purpose**: Enhanced data writing with PyShark integration and CSV export

**Key Features**:

- PyShark integration for Wireshark-based dissection
- RRC field extraction and CSV generation
- PDML XML output generation
- Protocol field mapping using actual Wireshark dissectors

**Supported Protocols**:

- LTE RRC (Radio Resource Control)
- NR RRC (5G Radio Resource Control)
- NAS (Non-Access Stratum) - EPS and 5GS
- GSM protocols
- GSMTAP encapsulation

### FileIO (fileio.py)

**Purpose**: Handles file input/output operations

**Features**:

- Support for compressed files (.gz, .bz2)
- Binary file reading with optional HDLC decoding
- File availability checking and next file queuing

### Qualcomm Parser (qualcomm/qualcommparser.py)

**Purpose**: Parses Qualcomm-specific diagnostic messages

**Key Components**:

- Main parser class with configurable parameters
- Support for different Qualcomm chipsets
- Layer-specific parsing (RRC, NAS, etc.)
- Integration with DataWriter for output

## Prerequisites

### System Requirements

- **Python**: 3.7 or higher
- **Operating System**: Linux (Ubuntu recommended), macOS, or Windows
- **Wireshark**: 2.6.0+ (3.0.0+ recommended for 5G support)
- **Memory**: 8GB+ RAM recommended for large files (>1GB)

### Dependencies

All required dependencies are installed during the environment setup process. The key dependencies are:

- **pyshark**: For Wireshark integration and PCAP processing
- **bitstring**: For binary data manipulation
- **lxml**: For XML processing (optional)
- **pandas**: For data analysis (optional)

### Sample Data

The parser includes sample files for testing:

- `pcap/attach_reject.pcap` - Sample PCAP file
- `output-v8.xml` - Example XML output
- `output-v8.csv` - Example CSV output

## Usage Examples

### Basic QMDL Processing

```bash
# Process QMDL file with XML and CSV output
python3 qmdl_reader.py diag_log.qmdl -o output-v1.xml -c output-v1.csv

# Process with custom minimum file size (default is 10MB)
python3 qmdl_reader.py large_dump.qmdl -s 50 -o output-v1.xml -c output-v1.csv

# Process without CSV export (XML only)
python3 qmdl_reader.py diag_log.qmdl -o output-v1.xml
```

### PCAP Processing

```bash
# Process PCAP file with XML and CSV output
python3 qmdl_reader.py pcap/attach_reject.pcap -o output-v1.xml -c output-v1.csv

# Process PCAP without CSV export
python3 qmdl_reader.py pcap/attach_reject.pcap -o output-v1.xml

# Process multiple PCAP files
for file in pcap/*.pcap; do
    python3 qmdl_reader.py "$file" -o "${file%.pcap}.xml" -c "${file%.pcap}.csv"
done
```

### Advanced Usage

```bash
# List all QMDL files in a directory
python3 qmdl_reader.py --list-qmdl /path/to/qmdl/directory

# Get file information
python3 qmdl_reader.py --info diag_log.qmdl

# Convert to PDML XML only (no CSV)
python3 qmdl_reader.py diag_log.qmdl -o output.xml
```

## Output Formats

### XML (PDML) Output

- **Format**: Packet Details Markup Language
- **Content**: Complete protocol dissection tree
- **Use Case**: Detailed protocol analysis, Wireshark-compatible
- **Structure**:
  ```xml
  <pdml>
    <packet>
      <proto name="lte_rrc">
        <field name="rrc.message_type" show="System Information Block Type 1"/>
        <field name="rrc.cellIdentity" show="12345678"/>
      </proto>
    </packet>
  </pdml>
  ```

### CSV Output

- **Format**: Comma-separated values
- **Content**: RRC-specific fields only
- **Use Case**: Spreadsheet analysis, data processing
- **Columns**: packet_number, various RRC field names
- **Sample Fields**:
  - Cell identity, PLMN information
  - Frequency and bandwidth parameters
  - Power control settings
  - Timing and synchronization data

## Troubleshooting

### Common Issues

#### 1. "File too small" Error

- **Cause**: QMDL file smaller than minimum size threshold
- **Solution**: Use `-s` flag to reduce minimum size or obtain larger capture

```bash
python3 qmdl_reader.py small_file.qmdl -s 1 -o output.xml
```

#### 2. PyShark Not Available

- **Cause**: PyShark library not installed
- **Solution**: Install PyShark or use fallback method

```bash
pip install pyshark
```

#### 3. Permission Issues

- **Cause**: Insufficient file permissions for input/output files
- **Solution**: Ensure read permissions for input files and write permissions for output directory

#### 4. No RRC Data in CSV

- **Cause**: Input file contains no RRC messages
- **Solution**: Verify input file contains RRC signaling data

### Performance Considerations

- **Large Files**: Processing large QMDL files (>1GB) may require significant memory
- **PyShark**: Optional but recommended for better protocol dissection
- **File Size**: Minimum 10MB recommended for meaningful analysis

## Sample Data and Testing

### Included Sample Files

- `pcap/attach_reject.pcap` - Sample PCAP file for testing
- `output-v8.xml` - Example XML output for reference
- `output-v8.csv` - Example CSV output for reference

### Testing the Parser

```bash
# Test with the included sample PCAP file
python3 qmdl_reader.py pcap/attach_reject.pcap -o test-output.xml -c test-output.csv

# Verify the output files were created
ls -la test-output.*

# Check the CSV content
head -5 test-output.csv

# Check the XML structure
head -20 test-output.xml
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## License

This parser is part of the SCAT (Signaling Collection and Analysis Tool) project and is licensed under GPL-2.0-or-later.

## References

- [SCAT Official Repository](https://github.com/fgsect/scat)
- [GSMTAP Protocol](https://osmocom.org/projects/baseband/wiki/GSMTAP)
- [Wireshark](https://www.wireshark.org/)
- [PyShark Documentation](https://pyshark.readthedocs.io/)

## Support

For questions and issues related to this parser:

- **Matrix Chat**: #scat-users:tchncs.de
- **Telegram Bridge**: @scat_users
- **Issues**: [GitHub Issues](https://github.com/fgsect/scat/issues)

## Command Line Reference

```
usage: qmdl_reader.py [-h] [-o OUTPUT] [-c CSV] [-s SIZE] input_file

QMDL/PCAP File Reader - PDML XML Output with RRC CSV Export

positional arguments:
  input_file            Input QMDL or PCAP file

options:
  -h, --help           show this help message and exit
  -o OUTPUT, --output OUTPUT
                       Output PDML XML file path
  -c CSV, --csv CSV    Output CSV file path for RRC data
  -s SIZE, --size SIZE  Minimum file size in MB for QMDL files (default: 10)
```

---

**Note**: This desktop parser provides offline processing capabilities for QMDL and PCAP files, converting them into XML and CSV formats for detailed cellular network analysis.
